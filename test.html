<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web App</title>
    <style>
        :root {
            --bg-color: #f0f0f0;
            --text-color: #333;
            --icon-stroke: #333;
            --bar-bg: #ffffff;
            --bar-border: #ddd;
            --song-bg: #ffffff;
            --song-hover: #f8f8f8;
            --error-color: #d32f2f;
            --panel-bg: #ffffff;
            --overlay-bg: rgba(0,0,0,0.5);
        }

        body.dark {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --icon-stroke: #e0e0e0;
            --bar-bg: #2a2a2a;
            --bar-border: #444;
            --song-bg: #2a2a2a;
            --song-hover: #333;
            --error-color: #ff4d4d;
            --panel-bg: #2a2a2a;
            --overlay-bg: rgba(0,0,0,0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: Arial, sans-serif;
            padding: 80px 10px;
        }

        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: var(--bar-bg);
            border-bottom: 1px solid var(--bar-border);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .top-bar .search-container {
            position: relative;
            display: flex;
            align-items: center;
            width: calc(100% - 10px);
            padding: 0 5px;
        }

        .top-bar .title-wrapper {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            width: auto;
            cursor: pointer;
        }

        .top-bar h1 {
            font-size: 24px;
            text-align: center;
            white-space: nowrap;
            line-height: 1;
            transition: opacity 0.4s ease-in-out, visibility 0.4s ease-in-out;
        }

        .top-bar .magnifier {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            cursor: pointer;
            fill: var(--icon-stroke);
            z-index: 3;
            display: block;
        }

        .top-bar .close-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            cursor: pointer;
            fill: var(--icon-stroke);
            z-index: 3;
            display: none;
        }

        .top-bar .search-input.active ~ .magnifier {
            display: none;
        }

        .top-bar .search-input.active ~ .close-icon {
            display: block;
        }

        .top-bar .search-input {
            width: 100%;
            padding: 10px 48px 10px 12px;
            font-size: 16px;
            line-height: 1.5;
            border: 1px solid var(--bar-border);
            border-radius: 24px;
            opacity: 0;
            transform: translateX(20px);
            visibility: hidden;
            transition: opacity 0.15s ease-in-out, transform 0.15s ease-in-out, visibility 0.15s ease-in-out;
            background-color: var(--bar-bg);
            color: var(--text-color);
        }

        .top-bar .search-input.active {
            opacity: 1;
            transform: translateX(0);
            visibility: visible;
        }

        .top-bar h1.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: var(--bar-bg);
            border-top: 1px solid var(--bar-border);
            display: flex;
            align-items: center;
            justify-content: space-around;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .bottom-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 56px;
            height: 56px;
            cursor: pointer;
            padding: 8px;
            display: block;
            overflow: visible;
        }

        .song-list {
            width: 99%;
            max-width: 900px;
            margin: 0 auto;
            min-height: 100px;
        }

        .song-item {
            padding: 15px;
            background-color: var(--song-bg);
            border-bottom: 1px solid var(--bar-border);
            border-radius: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            min-height: 60px;
            display: flex;
            align-items: center;
        }

        .song-item:last-child {
            border-bottom: none;
        }

        .song-item:hover {
            background-color: var(--song-hover);
        }

        .error-message {
            text-align: center;
            color: var(--error-color);
            margin-top: 20px;
            font-size: 16px;
        }

        .slide-panel {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-color: var(--panel-bg);
            box-shadow: -2px 0 5px rgba(0,0,0,0.2);
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 2000;
            padding: 20px;
            padding-top: 0;
            overflow-y: auto;
            color: var(--text-color);
        }

        .slide-panel.open {
            transform: translateX(0);
        }

        .slide-panel h2 {
            font-size: 28px;
            margin-top: 72px;
            margin-bottom: 20px;
            text-align: center;
            max-width: calc(100% - 80px);
            overflow-wrap: break-word;
            margin-left: auto;
            margin-right: auto;
        }

        .slide-panel p {
            font-size: 26px;
            line-height: 1.6;
            white-space: pre-wrap;
            margin: 0 10px;
            text-align: center;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 12px;
            cursor: pointer;
            z-index: 1;
            display: block;
            background: transparent;
            border: none;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
        }

        .close-button svg {
            width: 40px;
            height: 40px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--overlay-bg);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out;
            z-index: 1500;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        @media screen and (max-width: 500px) and (orientation: portrait) {
            body {
                padding: 80px 5px;
            }
            .song-item {
                padding: 12px;
                min-height: 54px;
            }
            .top-bar h1 {
                font-size: 20px;
                line-height: 1;
            }
            .top-bar .magnifier {
                width: 24px;
                height: 24px;
                right: 10px;
            }
            .top-bar .close-icon {
                width: 28px;
                height: 28px;
                right: 10px;
            }
            .top-bar .search-input {
                font-size: 15px;
                padding: 8px 44px 8px 10px;
                line-height: 1.5;
                border-radius: 24px;
            }
            .top-bar .search-container {
                padding: 0 5px;
                width: calc(100% - 10px);
            }
            .song-list {
                max-width: 100%;
            }
            .slide-panel h2 {
                font-size: 24px;
                margin-top: 72px;
            }
            .slide-panel p {
                font-size: 24px;
                text-align: center;
            }
            .bottom-icon {
                width: 48px;
                height: 48px;
                right: 10px;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="search-container">
            <div class="title-wrapper" id="title-wrapper" aria-label="Enter full-screen">
                <h1 id="top-title">CÃ¡nticos De Victoria</h1>
            </div>
            <input type="text" class="search-input" id="search-input" placeholder="Search songs...">
            <svg class="magnifier" id="magnifier" viewBox="0 0 24 24">
                <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
            <svg class="close-icon" id="close-icon" viewBox="0 0 24 24">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
        </div>
    </div>
    <div class="song-list" id="song-list">
        <p class="error-message">Loading songs, please wait...</p>
    </div>
    <div class="bottom-bar">
        <svg class="bottom-icon" id="bottom-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 125" aria-label="Switch to dark mode">
            <g>
                <path d="M50,25c-13.8,0-25,11.2-25,25c0,13.8,11.2,25,25,25s25-11.2,25-25C75,36.2,63.8,25,50,25z M30,50c0-11,9-20,20-20v40 C39,70,30,61,30,50z" fill="none" stroke="#333" stroke-width="3" stroke-miterlimit="10"/>
                <rect x="48" y="5" width="4" height="15" fill="none" stroke="#333" stroke-width="3" stroke-miterlimit="10"/>
                <rect x="80" y="48" width="15" height="4" fill="none" stroke="#333" stroke-width="3" stroke-miterlimit="10"/>
                <rect x="5" y="48" width="15" height="4" fill="none" stroke="#333" stroke-width="3" stroke-miterlimit="10"/>
                <rect x="48" y="80" width="4" height="15" fill="none" stroke="#333" stroke-width="3" stroke-miterlimit="10"/>
                <rect x="16" y="21.5" transform="matrix(0.7071 0.7071 -0.7071 0.7071 23.4835 -9.7272)" width="15" height="4" fill="none" stroke="#333" stroke-width="3" stroke-miterlimit="10"/>
                <rect x="74.5" y="16" transform="matrix(0.7071 0.7071 -0.7071 0.7071 39.0157 -47.2268)" width="4" height="15" fill="none" stroke="#333" stroke-width="3" stroke-miterlimit="10"/>
                <rect x="21.5" y="69" transform="matrix(-0.7071 -0.7071 0.7071 -0.7071 -14.0165 147.2271)" width="4" height="15" fill="none" stroke="#333" stroke-width="3" stroke-miterlimit="10"/>
                <rect x="69" y="74.5" transform="matrix(-0.7071 -0.7071 0.7071 -0.7071 76.5156 184.7272)" width="15" height="4" fill="none" stroke="#333" stroke-width="3" stroke-miterlimit="10"/>
            </g>
        </svg>
    </div>
    <div class="overlay" id="overlay"></div>
    <div class="slide-panel" id="slide-panel">
        <button class="close-button" id="close-button">
            <svg viewBox="0 0 24 24">
                <path d="M6 6 L18 18 M6 18 L18 6" fill="none" stroke="var(--text-color)" stroke-width="0.8"/>
            </svg>
        </button>
        <h2 id="song-title"></h2>
        <p id="song-lyrics"></p>
    </div>

    <script>
        const songList = document.getElementById('song-list');
        const slidePanel = document.getElementById('slide-panel');
        const overlay = document.getElementById('overlay');
        const closeButton = document.getElementById('close-button');
        const songTitle = document.getElementById('song-title');
        const songLyrics = document.getElementById('song-lyrics');
        const magnifier = document.getElementById('magnifier');
        const closeIcon = document.getElementById('close-icon');
        const searchInput = document.getElementById('search-input');
        const topTitle = document.getElementById('top-title');
        const titleWrapper = document.getElementById('title-wrapper');
        const bottomIcon = document.getElementById('bottom-icon');
        let songs = [];
        let isSearchActive = false;

        function normalizeString(str) {
            return str
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '');
        }

        function toggleFullScreen() {
            if (isSearchActive) return;
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    console.log('Entered full-screen');
                    titleWrapper.setAttribute('aria-label', 'Exit full-screen');
                }).catch(err => {
                    console.error('Full-screen error:', err);
                });
            } else {
                document.exitFullscreen().then(() => {
                    console.log('Exited full-screen');
                    titleWrapper.setAttribute('aria-label', 'Enter full-screen');
                }).catch(err => {
                    console.error('Exit full-screen error:', err);
                });
            }
        }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            const strokeColor = isDark ? '#e0e0e0' : '#333';
            document.documentElement.style.setProperty('--icon-stroke', strokeColor);
            bottomIcon.querySelectorAll('path, rect').forEach(el => {
                el.setAttribute('stroke', strokeColor);
            });
            bottomIcon.setAttribute('aria-label', isDark ? 'Switch to light mode' : 'Switch to dark mode');
        }

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark');
            document.documentElement.style.setProperty('--icon-stroke', '#e0e0e0');
            bottomIcon.querySelectorAll('path, rect').forEach(el => {
                el.setAttribute('stroke', '#e0e0e0');
            });
            bottomIcon.setAttribute('aria-label', 'Switch to light mode');
        } else {
            document.documentElement.style.setProperty('--icon-stroke', '#333');
        }

        searchInput.classList.remove('active');
        topTitle.classList.remove('hidden');

        console.log('Starting fetch for canticos.txt');
        fetch('canticos.txt')
            .then(response => {
                console.log('Fetch response received:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.text();
            })
            .then(text => {
                console.log('canticos.txt content received, length:', text.length);
                if (!text.trim()) {
                    throw new Error('canticos.txt is empty');
                }
                processSongs(text);
            })
            .catch(error => {
                console.error('Fetch Error:', error.message);
                songList.innerHTML = `
                    <p class="error-message">
                        Error loading songs: ${error.message}<br>
                        1. Ensure 'canticos.txt' is in the same directory as 'index.html'.<br>
                        2. Verify the file name is exactly 'canticos.txt' (case-sensitive, no extra spaces or extensions).<br>
                        3. Run the app through a local server (e.g., 'npx http-server', VS Code Live Server, or 'python -m http.server 8000').<br>
                        4. Check browser console (Developer Tools > Console) for details.<br>
                        5. Clear browser cache and try again.
                    </p>`;
            });

        function processSongs(text) {
            console.log('Processing songs...');
            const lines = text.split('\n').map(line => line.trim());
            songs = [];
            songList.innerHTML = '';

            let i = 0;
            while (i < lines.length) {
                if (lines[i] === '') {
                    i++;
                    continue;
                }

                const title = lines[i];
                i++;

                const lyricsLines = [];
                while (i < lines.length && lines[i] !== '') {
                    lyricsLines.push(lines[i]);
                    i++;
                }

                const lyrics = lyricsLines.join('\n');
                const subtitles = (lyrics.match(/\([^()]*\)/g) || []).map(sub => sub.slice(1, -1));

                songs.push({ title, lyrics, subtitles });

                const songItem = document.createElement('div');
                songItem.className = 'song-item';
                songItem.textContent = title;
                songItem.addEventListener('click', () => openSlidePanel(title, lyrics));
                songList.appendChild(songItem);
            }

            console.log('Songs processed:', songs.length);
            if (songs.length === 0) {
                songList.innerHTML = '<p class="error-message">No songs found in canticos.txt. Ensure the file has valid song data (title, blank line, lyrics, blank line).</p>';
            }
        }

        function openSlidePanel(title, lyrics) {
            console.log('Opening slide panel for:', title);
            songTitle.textContent = title;
            songLyrics.textContent = lyrics;
            slidePanel.classList.add('open');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeSlidePanel() {
            console.log('Closing slide panel');
            slidePanel.classList.remove('open');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        function toggleSearch() {
            isSearchActive = !isSearchActive;
            console.log('Toggling search:', isSearchActive);
            if (isSearchActive) {
                topTitle.classList.add('hidden');
                searchInput.classList.add('active');
                searchInput.focus();
            } else {
                topTitle.classList.remove('hidden');
                searchInput.classList.remove('active');
                searchInput.value = '';
                filterSongs('');
            }
        }

        function filterSongs(query) {
            console.log('Filtering songs with query:', query);
            songList.innerHTML = '';
            const normalizedQuery = normalizeString(query);
            const filteredSongs = songs.filter(song => 
                normalizeString(song.title).includes(normalizedQuery)
            );

            if (filteredSongs.length === 0) {
                songList.innerHTML = '<p class="error-message">No songs found.</p>';
                return;
            }

            filteredSongs.forEach(song => {
                const songItem = document.createElement('div');
                songItem.className = 'song-item';
                songItem.textContent = song.title;
                songItem.addEventListener('click', () => openSlidePanel(song.title, song.lyrics));
                songList.appendChild(songItem);
            });
        }

        titleWrapper.addEventListener('touchstart', (e) => {
            e.preventDefault();
            toggleFullScreen();
        });
        magnifier.addEventListener('click', toggleSearch);
        closeIcon.addEventListener('click', toggleSearch);
        searchInput.addEventListener('input', (e) => filterSongs(e.target.value));
        closeButton.addEventListener('click', closeSlidePanel);
        overlay.addEventListener('click', closeSlidePanel);
        bottomIcon.addEventListener('click', toggleTheme);

        document.addEventListener('fullscreenchange', () => {
            console.log('Fullscreen changed:', !!document.fullscreenElement);
            if (!document.fullscreenElement) {
                titleWrapper.setAttribute('aria-label', 'Enter full-screen');
            } else {
                titleWrapper.setAttribute('aria-label', 'Exit full-screen');
            }
        });
    </script>
</body>
</html>
